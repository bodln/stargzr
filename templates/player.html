<!DOCTYPE html>
<html>
<head>
    <title>MP3 Player</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
                body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        #player-controls {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 4px;
        }
        
        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        audio {
            width: 100%;
            margin-top: 20px;
        }
        
        .song-info {
            font-size: 18px;
            margin-bottom: 10px;
        }

        /* Radio Mode Styles */
        .mode-container {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .mode-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .mode-badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .mode-badge.private {
            background: #28a745;
            color: white;
        }
        
        .mode-badge.radio {
            background: #dc3545;
            color: white;
        }
        
        .mode-badge.broadcasting {
            background: #ffc107;
            color: black;
        }
        
        .radio-controls {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .radio-input-group {
            display: flex;
            gap: 10px;
        }
        
        .radio-input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .radio-input-group button {
            flex-shrink: 0;
        }
        
        .broadcaster-info {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .session-id-display {
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .hidden {
            display: none;
        }
        
        #debug-log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>MP3 Player</h1>
    
    <!-- Mode Indicator and Radio Controls -->
    <div class="mode-container">
        <div class="mode-indicator">
            <span id="mode-display" class="mode-badge private">Private Mode</span>
            <span id="broadcast-status" class="mode-badge broadcasting hidden">Broadcasting</span>
        </div>
        
        <div class="session-id-display">
            <strong>Your Session ID:</strong> <span id="my-session-id">{{ session_id }}</span>
            <button onclick="copySessionId()" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">üìã Copy</button>
        </div>
        
        <div id="broadcaster-info" class="broadcaster-info hidden">
            Tuned into: <strong id="broadcaster-name"></strong>
        </div>
        
        <div class="radio-controls">
    <!-- Tune In -->
            <div class="radio-input-group">
                <input 
                    type="text" 
                    id="broadcaster-input" 
                    placeholder="Paste broadcaster's session ID here..."
                    value="">
                <button id="tune-in-btn">üìª Tune In</button>
                <button id="tune-out-btn" class="hidden">üè† Back to Private</button>
            </div>
            
            <!-- Broadcasting Controls -->
            <div class="radio-input-group">
                <button id="broadcast-btn">üì° Start Broadcasting</button>
                <button id="stop-broadcast-btn" class="hidden">‚èπÔ∏è Stop Broadcasting</button>
            </div>
        </div>
    </div>
    
    <!-- Player Controls (existing) -->
    <div id="player-controls">
        <div class="song-info">
            <strong>Now Playing:</strong> {{ current_song }}
        </div>
        <div>
            Track {{ current_index + 1 }} of {{ total_songs }}
        </div>
    </div>
    
    <!-- Audio Player -->
        <audio id="audio-player" controls>
        <source src="/player/stream/{{ current_index }}" type="audio/mpeg">
        Your browser doesn't support audio playback.
    </audio>
    
    <!-- Playback Controls -->
    <div class="controls">
        <!-- Previous button -->
        <!-- hx-post sends a POST request to /player/prev -->
        <!-- hx-target="#player-controls" says "update the controls div" -->
        <!-- hx-swap="innerHTML" says "replace what's inside" -->
        <button 
            id="prev-btn"
            hx-post="/player/prev"
            hx-target="#player-controls"
            hx-swap="innerHTML">
            ‚èÆÔ∏è Previous
        </button>
        
        <!-- Next button - same pattern -->
        <button 
            id="next-btn"
            hx-post="/player/next"
            hx-target="#player-controls"
            hx-swap="innerHTML">
            Next ‚è≠Ô∏è
        </button>
    </div>
    
    <!-- Debug Log -->
    <div id="debug-log"></div>
    
    <script>
        // This JavaScript handles loading the new song when you click prev/next
        // We listen for HTMX's afterSwap event, which fires after the controls update
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Only run this for our player controls, not other HTMX updates
            if (event.detail.target.id === 'player-controls') {
                // Get the new song index from the updated HTML
                const songInfo = event.detail.target.textContent;
                const match = songInfo.match(/Track (\d+)/);
                
                if (match) {
                    const newIndex = parseInt(match[1]) - 1;
                    const audioPlayer = document.getElementById('audio-player');
                    const source = audioPlayer.querySelector('source');
                    
                    // Update the audio source to the new song
                    source.src = `/player/stream/${newIndex}`;
                    
                    // Tell the audio element to load and play the new song
                    audioPlayer.load();
                    audioPlayer.play();
                }
            }
        });

        // Prevent controls in radio mode
        document.body.addEventListener('htmx:beforeRequest', function(event) {
            if (player.isInRadioMode() && 
                (event.detail.target.id === 'prev-btn' || event.detail.target.id === 'next-btn')) {
                event.preventDefault();
                alert('Controls disabled while tuned into a radio');
            }
        });
    </script>
</body>
</html>